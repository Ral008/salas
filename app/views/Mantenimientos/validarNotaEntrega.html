#{extends 'main.html' /}
#{set title:'Validar Nota de Entrega' /}
#{set 'moreScripts'}
<script src="@{'/public/javascripts/bootstrap-datepicker.js'}" type="text/javascript" charset="${_response_encoding}"></script>
#{/set}
#{set 'moreStyles'}
<link rel="stylesheet" media="screen" href="@{'/public/stylesheets/datepicker.css'}">
#{/set}
<meta charset="UTF-8"/>
<div id="mensajes"></div>
<div class="well">
	<fieldset>
		<legend>:: Validar Nota de Entrega :: </legend>
		<div id="alert" class="alert alert-error" style="display: none;"><strong></strong>
		</div>
		<form class="form-horizontal" id="formularioNotaEntrega">
			<input name="coNotaEntrega" type="hidden" id="coNotaEntrega" value="" autocomplete="off">
			<div class="control-group">		
			    <div class="row">
					<div class="span5">
						<div class="control-group">
							<label class="control-label">Nro. Doc.</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="nroNotaEntrega" name="nroNotaEntrega" autocomplete="off"/>
								</div>
							</div>
						</div>												
					</div>
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Fecha Nota Entrega</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="daFechaNE" name="daFechaNE" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>					    					    				
					</div>																																				
				</div>				
				<div class="row">
				    <div class="span5">
					    <div class="control-group">
							<label class="control-label" for="coCliente">Cliente</label>
							<div class="controls">
								<select name="coCliente" id="coCliente" class="select" autocomplete="off" readonly="readonly">
									<option value="00">Seleccione</option>
								</select>							
							</div>
						</div>						
					</div>					
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Paciente</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="dePaciente" name="dePaciente" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>					    		
					</div>																													
				</div>
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">RUC</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="ruc" name="ruc" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Dr(a)</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deDoctora" name="deDoctora" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>														
					</div>																																				
				</div>
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Ciudad</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deCiudad" name="deCiudad" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>										
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Fecha Cirugia</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="daFechaCirugia" name="daFechaCirugia" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>																																				
				</div>	
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Telefono</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deTelefono" name="deTelefono" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>										
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Tipo Seguro</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deTipoSeguro" name="deTipoSeguro" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>																																				
				</div>
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Agente</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deAgente" name="deAgente" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>										
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Hist. Clinica</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deHistoriaClinica" name="deHistoriaClinica" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>																																				
				</div>
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Domicilio</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deDireccion" name="deDireccion" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>										
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Procedencia</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deProcedencia" name="deProcedencia" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>																																				
				</div>								
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Zona</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deZona" name="deZona" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>						
					</div>										
					<div class="span">
						<div class="control-group">
							<label class="control-label" for="coProductoCompuesto">Prod. Compuesto 01</label>
							<div class="controls">
								<select name="coProductoCompuesto" id="coProductoCompuesto" class="select" autocomplete="off">
									<option value="00">Seleccione</option>
								</select>	
								$ <input type="text" class="input-mini" id="pvprodCompuesto" value="0" readonly="readonly">							
							</div>							
						</div>
					</div>																																				
				</div>
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Lugar de entrega</label>
							<div class="controls">
							    <textarea id="deLugarEntrega" name="deLugarEntrega" rows="" cols="" autocomplete="off" readonly="readonly"></textarea>
							</div>
						</div>						
					</div>											
					<div class="span">
					    <div class="control-group">
							<label class="control-label" for="coProductoCompuesto">Prod. Compuesto 02</label>
							<div class="controls">
								<select name="coProductoCompuesto_02" id="coProductoCompuesto_02" class="select" autocomplete="off">
									<option value="00">Seleccione</option>									
								</select>	
								$ <input type="text" class="input-mini" id="pvprodCompuesto_02" value="0" readonly="readonly">							
							</div>							
						</div>						
					</div>																																																	
				</div>				
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Proforma</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="deProforma" name="deProforma" autocomplete="off" readonly="readonly"/>
								</div>
							</div>
						</div>		
					</div>											
					<div class="span">
					    <div class="control-group">
							<label class="control-label" for="coProductoCompuesto">Prod. Compuesto 03</label>
							<div class="controls">
								<select name="coProductoCompuesto_03" id="coProductoCompuesto_03" class="select" autocomplete="off">
									<option value="00">Seleccione</option>
								</select>	
								$ <input type="text" class="input-mini" id="pvprodCompuesto_03" value="0" readonly="readonly">							
							</div>							
						</div>						
					</div>																																																	
				</div>	
				<div class="row">
					<div class="span5">
					    <div class="control-group">
							<label class="control-label">Nro. Factura</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="nroFactura" name="nroFactura" autocomplete="off"/>
								</div>
							</div>
						</div>						
					</div>										
					<div class="span">
					    <div class="control-group">
							<label class="control-label">Fecha de Factura</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" id="daFechaFactura" name="daFechaFactura" autocomplete="off"/>
								</div>
							</div>
						</div>						
					</div>																																				
				</div>											
			</div>										
			<div class="form-actions">
				<button type="button" id="btnGuardar" class="btn btn-primary">Facturar</button>				
				<button type="button" id="btnCancelar" class="btn">Cancelar</button>			
			</div>
		</form>		
	</fieldset>
</div>
<div id="divMsj" class="alert"></div>
<table class="table table-striped table-bordered table-condensed" id="report-invoice">
	<thead>
		<tr>
		    <th style="color:#0088CC;">Cod. Prod. Proveedor</th>
		    <th style="color:#0088CC;">Descripcion</th>
		    <th style="color:#0088CC;">Cantidad</th>
		    <th style="color:#0088CC;">Retorno</th>
		    <th style="color:#0088CC;">Total vendido</th>
		    <th style="color:#0088CC;">$ Precio</th>
		    <th style="color:#0088CC;">$ Importe</th>			
		</tr>
	</thead>
	<tbody id="tabla-de-detalle-producto">		
	</tbody>
</table>
<div class="well">
<table>
<tr>
   <td style="font-weight:bold;">Total Bruto</td>
      <td><input type="text" class="input-mini" id="totalBruto" value="0" readonly="readonly">
   </td>   
   <td style="font-weight:bold;">Total Descuento</td>
      <td><input type="text" class="input-mini totalDescuentoLabel" id="totalDescuento" value="0">
   </td>
   <td style="font-weight:bold;">Base Imponible</td>
      <td><input type="text" class="input-mini" id="baseImponible" value="0" readonly="readonly">
   </td>
   <td style="font-weight:bold;">IVA</td>
      <td><input type="text" class="input-mini" id="iva" value="0" readonly="readonly">
   </td>
   <td style="font-weight:bold;">Neto a Pagar</td>
      <td><input type="text" class="input-mini" id="netoPagar" value="0" readonly="readonly">
   </td>                          
</tr>
</table>
</div>
<script type="text/javascript">
var ValidarProductos = function(){
		var detalle="@{Factura.index()}";	
		function init(){
			$('#coCliente').attr("disabled", true);
			$('#coProductoCompuesto').attr("disabled", true);
			$('#coProductoCompuesto_02').attr("disabled", true);
			$('#coProductoCompuesto_03').attr("disabled", true);
			$("#daFechaFactura").datepicker({format: 'dd/mm/yyyy',autoclose: true,language: 'es'});
			$(document).delegate("#nroNotaEntrega","keypress",buscarNotaEntrega);			
			$(document).delegate('.cantidadRetornoLable','keyup',calcularTotalVendidoEImporte); 
			$(document).delegate('.totalDescuentoLabel','keyup',calculaBaseImponible);
			$(document).delegate("#btnCancelar","click",cancelarNotaEntrega);
			$(document).delegate("#btnGuardar","click",guardarNotaEntregaComoFactura);			
		};	
		
		function calcularTotalVendidoEImporte(){
			var sum=0;			
	    	$('.cantidadRetornoLable').each(function(){
	    		var t = this;
	    		var retorno = parseInt($(t).val());		    			    		
	    	});	 
	    	calcularTotalVendido(); 
	    	calcularTotales();
		}
		
		function buscarNotaEntrega(e){
			if(e.keyCode==13){
			  if($.trim($('#nroNotaEntrega').val())==''){
				  scroll(0,0);
				  $.showMessage("error","Ingrese el numero documento de la Nota de Entrega","mensajes",true);
				  return false;
			  }else{
				  $.ajax({
						url:"@{Factura.buscarNotaEntregaByNroDocumento()}",
						data:{nroNotaEntrega  : $("#nroNotaEntrega").val()},
						success:function(json){
							if(json.length > 0){
								completarDatosDeNotaIngreso(json[0][0],json[0][0].coProductoCompuesto,json[0][0].deProductoCompuesto,json[0][0].coProductoCompuesto_02,json[0][0].deProductoCompuesto_02,json[0][0].coProductoCompuesto_03,json[0][0].deProductoCompuesto_03,json[0][0].coCliente,json[0][0].deCliente);
								if(json[1]){
									detalleProd = completarVentaDeProductos(json[1]);
									$("#tabla-de-detalle-producto").html(detalleProd);								
								}else{
									$("#tabla-de-detalle-producto").empty();
								}
								scroll(0,0);
								calcularTotalVendido();								
							}else{
								scroll(0,0);
								$.showMessage("error","Primero la Nota de Entrega tiene que DESPACHARSE / El numero de documento no existe o ya fue facturado","mensajes",true);
								$("#nroNotaEntrega").val("");
							}
						}					
					})
			  }										
			}
		}
		
		function completarDatosDeNotaIngreso(json,code01,name01,code02,name02,code03,name03,coCliente,deCliente){
			$.each(json,function(key,value){
				$("#"+key).val(value);
			})
			var html01 = '';
			html01+='<option value="'+code01+'">';
			html01+=name01;
			html01+='</option>';	
			$("#coProductoCompuesto").html(html01);
			var html02 = '';
			html02+='<option value="'+code02+'">';
			html02+=name02;
			html02+='</option>';	
			$("#coProductoCompuesto_02").html(html02);
			var html03 = '';
			html03+='<option value="'+code03+'">';
			html03+=name03;
			html03+='</option>';	
			$("#coProductoCompuesto_03").html(html03);			
			var htmlc = '';
			htmlc+='<option value="'+coCliente+'">';
			htmlc+=deCliente;
			htmlc+='</option>';	
			$("#coCliente").html(htmlc);
		}
		
		function completarVentaDeProductos(obj){
			var html ="";
			var cv = 0;
			for(var i = 0 ; i < obj.length ; i++){
				html+="<tr name='newf'>";
				
				html+="<td>";
			      html+="<input type='hidden' id='d_"+obj[i].id+"' value="+obj[i].id+" />";
			      html+=obj[i].codProdProveedorName;
		        html+="</td>";								
				html+="<td>"+obj[i].productoName+"</td>";
				html+="<td>"+obj[i].cantidadVentaName+"</td>";	
				html+="<td><input type='text' name='retorno' id='retorno_"+obj[i].id+"' autocomplete='off' class='input-mini cantidadRetornoLable' value='0'/></td>";
				html+="<td>"+obj[i].cantidadVentaName+"</td>";
				html+="<td>"+obj[i].precioVentaName+"</td>";
				html+="<td>"+obj[i].cantidadVentaName * obj[i].precioVentaName+"</td>";
				html+="<td style='text-align: center;'>";
				    html+="<input type='hidden' name='coDPTemp' value="+obj[i].id+">";									
				html+="</td>";
				html+="</tr>";
			}			
			return html;
		}
		
		function calcularTotalVendido(){
			var tv = 0;
			var imn = 0;
			$("#tabla-de-detalle-producto tr").each(function(){
			    _tr = this;
			    if(parseInt($("#retorno_"+$(_tr).find('input:[name="coDPTemp"]').val()).val()) > parseInt($(_tr).find("td").eq(2).text())){
					 $.showMessage("error","La cantidad de retorno es mayor que la cantidad enviada","divMsj",true);
					 $(_tr).find("td").eq(4).text($(_tr).find("td").eq(2).text());
					 $(_tr).find("td").eq(6).text(parseInt($(_tr).find("td").eq(2).text())*parseInt($(_tr).find("td").eq(5).text()));
					 //tv = 0;
					 //imn = 0;
					 $("#retorno_"+$(_tr).find('input:[name="coDPTemp"]').val()).val("0");
					return false;
			    }else{
			    	tv = parseInt($(_tr).find("td").eq(2).text()) - parseInt($("#retorno_"+$(_tr).find('input:[name="coDPTemp"]').val()).val());
				    $(_tr).find("td").eq(4).text(tv);
				    
				    imn =  parseFloat($(_tr).find("td").eq(4).text()) * parseFloat($(_tr).find("td").eq(5).text());
				    $(_tr).find("td").eq(6).text(imn);
				    
				    //tv = 0;
					//imn = 0;
			    	
			    }			    			   
			});   
		}
		
		function calcularTotales(){
			var sum = 0;
			$("#tabla-de-detalle-producto tr").each(function(){
			    _tr = this;
			    sum = sum + parseFloat($(_tr).find("td").eq(6).text());
			});
			$("#totalBruto").val(parseFloat($("#pvprodCompuesto").val()) + parseFloat($("#pvprodCompuesto_02").val()) + parseFloat($("#pvprodCompuesto_03").val()) + sum);					
			
			var bi = parseFloat($("#totalBruto").val()) - parseFloat($("#totalDescuento").val());
	    	$("#baseImponible").val(bi);
	    	$("#iva").val(parseFloat(bi*0.12).toFixed(2));
	    	$("#netoPagar").val(parseFloat(bi + bi*0.12).toFixed(2));
		}
		
		function calculaBaseImponible(){
			var bi = parseFloat($("#totalBruto").val()) - parseFloat($("#totalDescuento").val());
	    	$("#baseImponible").val(bi);
	    	$("#iva").val(parseFloat(bi*0.12).toFixed(2));
	    	$("#netoPagar").val(parseFloat(bi + bi*0.12).toFixed(2));
		}
		
		function cancelarNotaEntrega(){
			scroll(0,0);
	    	location.reload();
		}
		
		function guardarNotaEntregaComoFactura(){
			  if($.trim($('#coNotaEntrega').val())==''){
				  scroll(0,0);
				  $.showMessage("error","Tiene que buscar la Nota de Entrega","mensajes",true);
				  return false;
			  }else{
				  if($.trim($('#nroFactura').val())==''){
					   scroll(0,0);
					   $.showMessage("error","Ingrese el numero de la factura","mensajes",true);
					   return false;
				   }else{
						if($.trim($('#daFechaFactura').val())==''){
							scroll(0,0);
							$.showMessage("error","Ingrese la fecha de la factura","mensajes",true);
							return false;
						}else{
							if($.trim($('#totalDescuento').val())==''){
								scroll(0,0);
								$.showMessage("error","Ingrese el valor del descuento","mensajes",true);
								return false;
							}else{
								$.ajax({
									url:"@{Factura.guardarNotaEntregaComoFactura()}",
									data:{																			
										"coNotaEntrega" 	           : $("#coNotaEntrega").val(),
										"nroFactura" 	               : $("#nroFactura").val(),
										"daFechaFactura" 	           : $("#daFechaFactura").val(), 
										"totalBruto" 	               : $("#totalBruto").val(),
										"totalDescuento" 	           : $("#totalDescuento").val(),
										"baseImponible" 	           : $("#baseImponible").val(),
										"iva" 	              	       : $("#iva").val(),
										"netoPagar" 	               : $("#netoPagar").val(),																		             														   
										"detalleDVP"		           : $("tr[name='newf'] input[id*='d_']").map(function(){
												                            return this.value+","+$(this).parent().next().next().text()+","+$(this).parent().next().next().next().next().text()+","+$(this).parent().next().next().next().next().next().next().text();
																	     }).get().join("@")						  
										},
										success:function(obj){
										 if(obj.status == 1 || obj.status == 2){
											scroll(0,0);
											$.showMessage("success",obj.message,"mensajes",true);
											location.reload();
										 }else{
											scroll(0,0);
											$.showMessage("error",obj.message,"mensajes",true);											
										 }
									    }
									})															
						   }
						}													
				   }											
			   }				  
		}				
		
	return {init : init}
}();
ValidarProductos.init();
</script>