#{extends 'main.html' /}
#{set title:'Sala' /}
<meta charset="UTF-8"/>
<div id="mensajes"></div>
<div class="well">
	<fieldset>
		<legend>:: Sala :: </legend>
		<form class="form-horizontal" id="formularioSala">
			<input name="coSala" type="hidden" id="coSala" value="" autocomplete=" ">
			<div class="control-group">						
				<div class="row">
				    <div class="span5">
						<div class="control-group">
							<label class="control-label" for="coLocal">Local</label>
							<div class="controls">
								<select name="coLocal" id="coLocal" class="select" autocomplete="off">
									<option value="00">Seleccione</option>
									#{list listLocal,as:'local'}
									<option value="${local.coLocal}">${local.deNombre}</option>
									#{/list}
								</select>								
							</div>
						</div>
					</div>																																		
				</div>					
				<div class="row">
				    <div class="span5">
					    <div class="control-group">
							<label class="control-label" for="deNombre">Nombre</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" name="deNombre" id="deNombre" autocomplete="off" />
								</div>
							</div>
						</div>						
					</div>					
					<div class="span">
						<div class="control-group">
							<label class="control-label" for="aforo">Aforo</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" name="aforo" id="aforo" autocomplete="off" class="span1"/>
								</div>
							</div>
						</div>
					</div>																													
				</div>					
				<div class="row">				    	
					<div class="span5">
						<div class="control-group">
							<label class="control-label" for="deUbicacion">Ubicación</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" name="deUbicacion" id="deUbicacion" autocomplete="off" placeholder="Piso 4"/>
								</div>
							</div>
						</div>
					</div>	
					<div class="span">
					    <div class="control-group">
							<label class="control-label" for="deDimension">Dimensión</label>
							<div class="controls">
								<div class="input-append">
									<input type="text" name="deDimension" id="deDimension" autocomplete="off" class="span1" placeholder="A x L"/>
								</div>
							</div>
						</div>						
					</div>																																				
				</div>	
				<div class="row">				    					
					<div class="span5">
					    <div class="control-group">
							<label class="control-label" for="deDescripcion">Descripción</label>
							<div class="controls">
								<div class="input-append">
									<textarea id="deDescripcion" name="deDescripcion" rows="" cols="" class="span5" maxlength="800" placeholder="Descripción.." autocomplete="off"></textarea>
								</div>
							</div>
						</div>						
					</div>																													
				</div>
				<div class="row">				    					
					<div class="span5">
					    <div class="control-group">
							<label class="control-label" for="deAviso">Aviso</label>
							<div class="controls">
								<div class="input-append">
									<textarea id="deAviso" name="deAviso" rows="" cols="" class="span5" maxlength="800" placeholder="Aviso.." autocomplete="off"></textarea>
								</div>
							</div>
						</div>						
					</div>																													
				</div>		
				<div class="row">
					<div class="span5">
					  <div class="control-group">
				        <label class="control-label" style="color: #333333;">Máximo 2 MB</label>
				        <div class="controls">
					       <button type="button" id="fileupload" class="btn btn-inverse">Foto</button>
					       <span class="help-inline"></span>
					       <img id="loadFoto" src="@{'/public/images/ajax-loaderCombo.gif'}" class="hide">
				        </div>
			          </div>
					</div>																																							
				</div>										
			</div>	
			<div class="control-group">  
				<div class="accordion">
					<div class="accordion-group">
						<div class="accordion-heading">
				      		<a class="accordion-toggle">
				      			Agregar Material
				      		</a>
				    	</div>		    
					   	<div id="1" class="accordion-body collapse in" style="height: height: 0px; ">
					    	<div class="accordion-inner">
					    	    <div class="row">
									<div class="span">
										<div class="control-group">
										    <label class="control-label required-form" for="cboMaterial">Material</label>
											<div class="controls">
												<select id="cboMaterial" type="select-one" name="cboMaterial" class="span5" autocomplete="off" >
												    <option value="00">Seleccione</option>	
												    #{list listMaterial,as:'material'}
									                <option value="${material.coMaterial}">${material.deNombre}</option>
									                #{/list}								               
												</select>
											</div>
										</div>
									</div>	
									<div class="span4" style="margin-left: 20px;">
					                   <button class="btn" id="btnAgregarMateriales" type="button"><i class="icon-ok"></i>Agregar</button>					         					             
					                </div>																																																												
								</div>																								
<!-- 								<div class="row"> -->
<!-- 								   <div class="control-group"> -->
<!-- 								     <div style="margin-left:29px;"> -->
<!-- 								      <div class="controls"> -->
<!-- 									     <div class="span5"> -->
<!-- 										    <button class="btn" id="btnAgregarMateriales" type="button"><i class="icon-ok"></i>Agregar</button> -->
<!-- 									     </div>	 -->
<!-- 									  </div> -->
<!-- 								     </div>							 -->
<!-- 								   </div> -->
<!-- 								</div>								 -->
								 <p></p>
                                 <div class="row">
									   <div class="span1">
											<div class="control-group">						    
												<label class="control-label"></label>							
											</div>												
										</div>
									   <div class="span6">
									      <table class="table table-striped table-bordered table-condensed" >
												<thead>
													<tr>		
													    <th style="color:#0088CC">Material</th>															
														<th width="12%" style="color:#0088CC;text-align:center">Opción</th>
													</tr>
												</thead>
												<tbody id="tabla-de-materiales-para-sala"></tbody>	
										   </table>
					                  </div>
			                      </div>
					      	</div>
					   	</div>
					</div>
				</div>
			</div>									
			<div class="form-actions">
				<button type="button" id="btnGuardar" class="btn btn-primary">Guardar</button>				
				<button type="button" id="btnCancelar" class="btn">Cancelar</button>			
			</div>
		</form>		
	</fieldset>
</div>
<div class="modal hide" id="myModal">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">x</a>
    <h3>Foto</h3>
  </div>
  <div class="modal-body">
  <div id="imagen"></div>
  </div>
</div>
<form action="" onsubmit="return false" class="well form-search" id="buscarSala">
    <h4 style="color:#0088CC">Mis salas registradas</h4><p></p>
	<input type="text" name="txtNombreBuscar" id="txtNombreBuscar" class="input-xlarge" placeholder="Buscar por nombre de sala" autocomplete="off">
	<button type="submit" class="btn">Buscar</button>
	<img id="loadBuscar" src="@{'/public/images/ajax-loaderCombo.gif'}" class="hide">
</form>
#{pagination.pag lista:listSala, titulo:'Sala', cab:'Id,Sala,Local,Aforo,Ubicacion,Estado,Opc', cantidadPestana:15, itemPag:500}
<tr>
<td key="coSala" valor="${item.coSala}">${item.coSala}</td>
<td key="deNombre" valor="${item.deNombre}">${item.deNombre}</td>
<td key="coLocal" valor="${item.vmdbLocal.coLocal}">${item.vmdbLocal.deNombre}</td>
<td key="aforo" valor="${item.aforo}">${item.aforo}</td>
<td key="deUbicacion" valor="${item.deUbicacion}">${item.deUbicacion}</td>
<td key="stSala" valor="${item.stSala}">${item.stSala == '1' ? 'Activo' : item.stSala == '2' ? 'Bloqueado' : 'Inactivo'}</td>
<td>
	<a class="btn btn-mini" id="u_${item.coSala}"><i class="icon-pencil" title="Editar"></i></a>
	<a class="btn btn-mini" id="e_${item.coSala}"><i class="icon-trash" title="Eliminar"></i></a>
	#{if item.stSala=='1'}
	<a class="btn btn-mini" id="b_${item.coSala}"><i class="icon-lock" title="Bloquear"></i></a>
	#{/if}
	#{if item.stSala=='2'}
	<a class="btn btn-mini" id="d_${item.coSala}"><i class="icon-ok" title="Desbloquear"></i></a>
	#{/if}
	<a class="btn btn-mini" id="i_${item.coSala}"><i class="icon-eye-open"></i> Foto</a>
</td>
</tr>
#{/pagination.pag}
<script type="text/javascript">
var rutaPaginacionSala = '@{Sala.paginacion()}';
var Salas = {
		capaDeMensajes : "mensajes",
		init : function(){
			$('#cboMaterial').select2();
			$(document).delegate("#btnAgregarMateriales","click",Salas.agregarMaterialADetalle);			
			$(document).delegate("a[name='newDelete']","click",Salas.removeRow);			
			$("#btnCancelar").click(Salas.cancelarSala);			
			$("#buscarSala").submit(Salas.buscarSala);				
			$("#btnGuardar").click(Salas.guardarSala);			
			$(document).delegate("a[id*='u_']","click",Salas.editarSala);
			$(document).delegate("a[id*='e_']","click",Salas.eliminar);
			$(document).delegate("a[id*='b_']","click",Salas.bloquear);
			$(document).delegate("a[id*='d_']","click",Salas.desBloquear);
			$(document).delegate("a[name='oldDelete']","click",Salas.eliminarMaterialDeLaSala);
			$(document).delegate("a[id*='i_']","click",Salas.verImagen);
			var button = $('#fileupload'), interval;
			new AjaxUpload(button,{
				action: '@{Sala.guardarFoto()}',
				responseType: 'json',
				name: 'foto',
				onSubmit : function(file, ext){
					if (! (ext && /^(jpg|JPG|PNG|JPEG|GIF|png|jpeg|gif)$/.test(ext))){
						$("#loadFoto").hide();
		            	$("#fileupload").parents(".control-group").addClass("error").find(".help-inline").text('Seleccione una foto valida'); 
		                return false; 
		 			}else{
		 				if(this._input.files[0].size>2097152){
		 					$("#loadFoto").hide();
			            	$("#fileupload").parents(".control-group").addClass("error").find(".help-inline").text('El tamaÃ±o maximo es 2 MB'); 
			                return false; 
		 				}
		 				$("#loadFoto").show();
		 				$("#fileupload").parents(".control-group").find(".help-inline").empty();
		 			}
				},
				onComplete: function(file, response){
					//$("#deFoto").val('');
					$("#loadFoto").hide();
					$("#fileupload").parents(".control-group").removeClass("error").addClass("success").find(".help-inline").html(response[0]+' '+'<a href="javascript:Salas.verFoto()">Ver imagen</a>');
		    	}
			});
		},	
		verFoto : function(){
			if($.trim($("#coSala").val())!=''){
				$("#imagen").empty().html('<img src="@{Sala.verFoto()}?azar='+Math.random()+'&deFoto='+$("#coSala").val()+'.jpg'+'" />');
			}else{
				$("#imagen").empty().html('<img src="@{Sala.verFoto()}?azar='+Math.random()+'" />');
			}
			$('#myModal').modal();
		},
		verImagen : function(){
			_this = this;
			_id = this.id.substring(2);
		    $("#imagen").empty().html('<img src="@{Sala.verFoto()}?azar='+Math.random()+'&deFoto='+_id+'.jpg'+'" />');			
			$('#myModal').modal();
		},
		desBloquear : function(){
			if(confirm("Desea desBloquear la sala? ")){
				_this = this;
				_id = this.id.substring(2);
				$.ajax({
					url:"@{Sala.desBloquear()}",
					data:{id : _id},
					success:function(result){
						scroll(0,0);
						if(result.status == 1){							
							$.showMessage("success",result.message,Salas.capaDeMensajes,true);
							//$(_this).parents("tr").remove();
							Salas.listar();
						}else{
							$.showMessage("error",result.message,Salas.capaDeMensajes,true);
						}
					}
				})
			}									
		},
		bloquear : function(){
			if(confirm("Desea bloquear la sala? ")){
				_this = this;
				_id = this.id.substring(2);
				$.ajax({
					url:"@{Sala.bloquear()}",
					data:{id : _id},
					success:function(result){
						scroll(0,0);
						if(result.status == 1){							
							$.showMessage("success",result.message,Salas.capaDeMensajes,true);
							//$(_this).parents("tr").remove();
							Salas.listar();
						}else{
							$.showMessage("error",result.message,Salas.capaDeMensajes,true);
						}
					}
				})
			}									
		},
		agregarMaterialADetalle : function(e){
			e.preventDefault();
			var coMaterialDt = $("#cboMaterial").val();						
				
			if((coMaterialDt ==null || $.trim(coMaterialDt) == "00")){
				scroll(0,0);
				$.showMessage("error","No hay ningun item seleccionado.",Salas.capaDeMensajes,true);			
			}else{
				if(Salas.validarIngreso(coMaterialDt)){
					Salas.insertarRegistroNuevo();
					$("#cboMaterial").val("00");
					$('#cboMaterial').select2();										
				}else{
					scroll(0,0);
					$.showMessage("error","Este item ya ha sido ingresado",Salas.capaDeMensajes,true);				
				}													
			}				
		},
		insertarRegistroNuevo : function(){
			/*Datos para la pantalla*/
			materialName = $("#cboMaterial option:selected").html();			
			/*Codigos*/
			coMaterial = $("#cboMaterial").val();
			
			var insertar = [{coMaterial         : coMaterial,
				             materialName       : materialName							 							
							}];			
			$("#tabla-de-materiales-para-sala").append(Salas.completarMaterialesParaSala(insertar,true));		
		},
		completarMaterialesParaSala : function(json,isNew){
			var html="";
			for(var i = 0 ; i < json.length ; i++){
				if(isNew){
					html+="<tr name='new'>";	
				}else{
					html+="<tr>";	
				}				
			        html+="<td>";
				      html+="<input type='hidden' id='m_"+json[i].coMaterial+"' value="+json[i].coMaterial+" />";
				      html+=json[i].materialName;
			        html+="</td>";									   			    						    			
					if(isNew){
						html+="<td style='text-align:center'>";
							html+="<a name='newDelete' class='btn btn-mini'><i class='icon-trash'></i></a>";
						html+="</td>";
					}else{
						html+="<td style='text-align:center'>";
	 						//html+="<a name='editOld' class='btn btn-mini' data-idcoproducto='"+json[i].coProducto+"' data-idcantidadcompraname='"+json[i].cantidadCompraName+"' data-idcostocompraname='"+json[i].costoCompraName+"' data-idvar1='"+json[i].coProducto+"' data-idvar2='"+json[i].coProducto+"' data-idvar3='"+json[i].coProducto+"' data-idpreciosugeridoname='"+json[i].precioSugeridoName+"' data-idprecioventaname='"+json[i].precioVentaName+"' data-iddetalleingresoproducto='"+json[i].id+"'><i class='icon-pencil'></i></a> ";																		
							html+="<a name='oldDelete' class='btn btn-danger btn-mini' id='dms_"+json[i].id+"'><i class='icon-trash icon-white'></i></a>";
						html+="</td>";
					}
				html+="</tr>";
			}
			return html;
		},
		validarIngreso : function(coMaterialDt){
			var count = 0;
			$("#tabla-de-materiales-para-sala tr").each(function(){
			    _tr = this;
			    hidden = $(_tr).find(":hidden");    
			    if(hidden[0].id.substring(2) == coMaterialDt){
			        count++;
			    }
			});
			if(count == 0){
			    console.info(true);
			    return true;
			}else{
			    console.info(false);
			    return false;
			}
		},
		removeRow : function(){
			_a = this;
			$(_a).parents("tr").remove();
		},						
		buscarSala : function(e){				
			e.preventDefault();
			$("#loadBuscar").show();
			$('#paginationSala').load('@{Sala.buscar()}?azar='+Math.random(),
		    $("#buscarSala").serialize(),
			function() {
				$("#loadBuscar").hide();
			});
		},			
		listar : function(){
			$("#txtNombreBuscar").val('');
			$("#loadBuscar").show();
			$('#paginationSala').load('@{Sala.buscar()}?azar='+Math.random(),
			$("#buscarSala").serialize(),
			function() {
				$("#loadBuscar").hide();
				$("#"+Salas.capaDeMensajes).slideUp("slow");
			});
		},				
		guardarSala : function(){
			if($("#coLocal").val()=="00"){
				scroll(0,0);
				$.showMessage("error","Seleccione el local",Salas.capaDeMensajes,true);
				return false;
			}else{
				if($.trim($('#deNombre').val())==''){
					  scroll(0,0);
					  $.showMessage("error","Ingrese el nombre de la sala",Salas.capaDeMensajes,true);
					  return false;
				  }else{
					  if($.trim($('#aforo').val())==''){
						   scroll(0,0);
						   $.showMessage("error","Ingrese el aforo de la sala",Salas.capaDeMensajes,true);
						   return false;
					   }else{
						   $.ajax({
								url:"@{Sala.guardarSala()}",
								data:{
									"sala.coSala" 	         : $("#coSala").val(),
									"sala.vmdbLocal.coLocal" : $("#coLocal").val(),
									"sala.deNombre" 	     : $("#deNombre").val(),
									"sala.aforo" 	         : $("#aforo").val(),
									"sala.deDimension" 	     : $("#deDimension").val(),
									"sala.deUbicacion" 	     : $("#deUbicacion").val(),
									"sala.deDescripcion" 	 : $("#deDescripcion").val(),
									"sala.deAviso" 	         : $("#deAviso").val(),
									"sala.stSala"       	 : '1',	
									"codMaterial"		     : $("tr[name='new'] input[id*='m_']").map(function(){
								                                 return this.value;
						                                       }).get().join("@")                                                   																			                																			                																			                												 
									},
									success:function(obj){
									 if(obj.status == 1 || obj.status == 2){
										scroll(0,0);
										$.showMessage("success",obj.message,Salas.capaDeMensajes,true);
										Salas.cancelarSala();
										Salas.listar();
									 }else{
										scroll(0,0);
										$.showMessage("error",obj.message,Salas.capaDeMensajes,true);
									 }
								    }
									});									   		  
					   }
				  } 
			}						  		   					
		},						
		editarSala : function(){
			$("#formularioSala").clearAll();
			_id = this.id.substring(2);	
			Salas.buscarSalaId(_id);
			$("#btnGuardar").text("Editar");	
		},
		buscarSalaId : function(_id){
			$.ajax({
				url:"@{Sala.buscarSalaById()}",
				data:{id : _id},
				success:function(json){
					if(json.length > 0){
						Salas.completarDatosDeLaSala(json[0][0]);
						if(json[1]){
							detalleMaterial = Salas.completarMaterialesParaSala(json[1]);
							$("#tabla-de-materiales-para-sala").html(detalleMaterial);
							/*Colocando popover a los botones de eliminar*/
							/*$("a[name='oldDelete']").popover({title:"Cuidado",placement:"left",content:"Si eliminas este registro, puedes alterar algunos que esten vinculados "});*/
						}else{
							$("#tabla-de-materiales-para-sala").empty();
						}
						scroll(0,0);
						$.showMessage("success","Se encontraron datos de la sala",Salas.capaDeMensajes,true);
					}
				},
				complete:function(){
				}			
			})
		},
		completarDatosDeLaSala : function(json){
			$.each(json,function(key,value){
				$("#"+key).val(value);
			})
		},
		eliminar : function(){
			if(confirm("Desea eliminar la sala? ")){
				_this = this;
				_id = this.id.substring(2);
				$.ajax({
					url:"@{Sala.eliminar()}",
					data:{id : _id},
					success:function(result){
						scroll(0,0);
						if(result.status == 1){							
							$.showMessage("success",result.message,Salas.capaDeMensajes,true);
							$(_this).parents("tr").remove();
						}else{
							$.showMessage("error",result.message,Salas.capaDeMensajes,true);
						}
					}
				})
			}									
		},
		eliminarMaterialDeLaSala : function(){
			_this = this;
			_a = this.id.substring(4);
			if(confirm("Desea eliminar esta información ? ")){
				$.ajax({
					url: '@{Sala.eliminarMaterialDeLaSalaById()}',
					data:{id : _a },
					success:function(result){
						if(result.status == 1){
							$.showMessage("success",result.message,Salas.capaDeMensajes,true);
							$(_this).parents("tr").remove();
						}else{
							$.showMessage("error",result.message,Salas.capaDeMensajes,true);
						}
					}				
				});
			}
		},																															
		cancelarSala : function(){	
			$("#cboMaterial").val("00");
			$('#cboMaterial').select2();
			$("#tabla-de-materiales-para-sala").empty();
			$("#formularioSala").clearAll();
			$("#formularioSala").cleanForm();
			$("#btnGuardar").text("Guardar");	
			location.reload();
		},
}
$(function(){
	Salas.init();
});
</script>